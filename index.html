<html>

  <head>
    <title>Activity Recognition - with Feature Save</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    <meta name="mobile-web-app-capable" content="yes">

    <link rel="stylesheet" href="https://web.sfc.keio.ac.jp/~slash/ABC/ac/themes/TOBASIC.css" />
    <link rel="stylesheet" href="https://web.sfc.keio.ac.jp/~slash/ABC/ac/themes/jquery.mobile.icons.min.css" />

    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>

    <link rel="stylesheet" href="https://code.jquery.com/mobile/1.4.5/jquery.mobile.structure-1.4.5.min.css" />

    <style>
      .control-buttons {
        margin: 10px 0;
      }
      .control-buttons button {
        margin: 5px;
        padding: 10px 20px;
        font-size: 1em;
      }
      .info-box {
        background-color: #f0f0f0;
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
      }
      #feature-history {
        width: 95%;
        height: 300px;
        font-family: monospace;
        font-size: 0.9em;
      }
      .label-input {
        margin: 10px 0;
      }
      .label-input input {
        padding: 8px;
        font-size: 1em;
        width: 200px;
      }
    </style>
  </head>

  <body>
    <h2>Activity Recognition (ç‰¹å¾´é‡ä¿å­˜ç‰ˆ)</h2>

    <div class="control-buttons">
      <button onclick="requestMotionPermission();">Get permission and start sensing</button>
      <button onclick="stopDeviceMotion();">Stop</button>
    </div>

    <div class="info-box">
      <strong>åé›†ãƒ•ãƒ¬ãƒ¼ãƒ æ•°:</strong> <span id="frame-count" style="font-size:1.5em; color:blue;">0</span>
    </div>

    <div class="label-input">
      <label for="activity-label"><strong>ç¾åœ¨ã®è¡Œå‹•ãƒ©ãƒ™ãƒ«:</strong></label>
      <input type="text" id="activity-label" placeholder="ä¾‹: walking, still, running" value="unknown">
      <small style="display:block; margin-top:5px;">â€» è¡Œå‹•ã‚’å¤‰ãˆã‚‹æ™‚ã«ãƒ©ãƒ™ãƒ«ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„</small>
    </div>

    <h3>(3) Classification result</h3>
    <ul>
    <li> Result: <span id="current_result" style="color:red;font-size:2.0em; font-weight: bold; border-top: 1px solid black; border-bottom: 1px solid black;">null</span> </li>
    </ul>

    <h3>(2) Features for this time window</h3>
    <ul>
    <li> min x: <span id="xmin">0</span> </li>
    <li> max x: <span id="xmax">0</span> </li>
    <li> ave x: <span id="xave">0</span> </li>
    <li> variance x: <span id="xvariance">0</span> </li>

    <li> min y: <span id="ymin">0</span> </li>
    <li> max y: <span id="ymax">0</span> </li>
    <li> ave y: <span id="yave">0</span> </li>
    <li> variance y: <span id="yvariance">0</span> </li>

    <li> min z: <span id="zmin">0</span> </li>
    <li> max z: <span id="zmax">0</span> </li>
    <li> ave z: <span id="zave">0</span> </li>
    <li> variance z: <span id="zvariance">0</span> </li>
    </ul>

    <h3>ğŸ“Š ç‰¹å¾´é‡å±¥æ­´ (CSVå½¢å¼)</h3>
    <div class="control-buttons">
      <button onclick="copyFeatures();">ğŸ“‹ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼</button>
      <button onclick="clearFeatures();">ğŸ—‘ï¸ å±¥æ­´ã‚’ã‚¯ãƒªã‚¢</button>
    </div>
    <textarea id="feature-history" readonly></textarea>

    <hr/>

    <h3>(1) Raw sensor values for this time window</h3>
    <ul>
    <li> X: <span id="accel-x">0</span> </li>
    <li> Y: <span id="accel-y">0</span> </li>
    <li> Z: <span id="accel-z">0</span> </li>
    </ul>

    <textarea id="raw-data" style="width:90%;height:30vh;"></textarea>

    <hr style="margin-top: 50px; border: 2px solid #333;"/>

    <!-- ============================================ -->
    <!-- ãƒ¬ãƒãƒ¼ãƒˆ -->
    <!-- ============================================ -->
    <div style="max-width: 800px; margin: 40px auto; padding: 25px; background-color: #ffffff; border: 1px solid #ddd; border-radius: 5px;">

      <h2 style="color: #333; border-bottom: 2px solid #666; padding-bottom: 10px;">Activity Recognition - ãƒ¬ãƒãƒ¼ãƒˆ</h2>

      <p style="color: #666; margin-bottom: 20px;">
        <strong>å­¦ç±ç•ªå·</strong>: 72405264<br>
        <strong>æ°å</strong>: æ´¥å‰ ç›´<br>
        <strong>ä½œæˆæ—¥</strong>: 2025å¹´11æœˆ7æ—¥
      </p>

      <!-- 1. ã‚„ã£ãŸã“ã¨ -->
      <h3 style="color: #555; margin-top: 25px;">1. ã‚„ã£ãŸã“ã¨</h3>
      <p style="line-height: 1.7;">
        ã‚¹ãƒãƒ›ã®åŠ é€Ÿåº¦ã‚»ãƒ³ã‚µãƒ¼ã‚’ä½¿ã£ã¦ã€æ©Ÿæ¢°å­¦ç¿’ã§è¡Œå‹•ã‚’èªè­˜ã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½œã‚Šã¾ã—ãŸã€‚
        æ­©ãã€èµ°ã‚‹ã€é™æ­¢ã€éšæ®µã‚’ç™»ã‚‹ãƒ»ä¸‹ã‚Šã‚‹ã€éŸ³æ¥½ã‚’è´ããªãŒã‚‰æ­©ãã€ãªã©7ç¨®é¡ã®è¡Œå‹•ã‚’åˆ¤åˆ¥ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚
      </p>

      <!-- 2. ä½¿ã£ãŸãƒ„ãƒ¼ãƒ« -->
      <h3 style="color: #555; margin-top: 25px;">2. ä½¿ã£ãŸãƒ„ãƒ¼ãƒ«</h3>
      <ul style="line-height: 1.8;">
        <li><strong>æ©Ÿæ¢°å­¦ç¿’ãƒ©ã‚¤ãƒ–ãƒ©ãƒª</strong>: scikit-learn (Python)</li>
        <li><strong>æ–¹æ³•</strong>: æ±ºå®šæœ¨ï¼ˆifæ–‡ã§æ¡ä»¶åˆ†å²ã—ã¦ã„ãæ–¹æ³•ï¼‰</li>
        <li><strong>ãƒ‡ãƒ¼ã‚¿æ•°</strong>: 115å€‹ï¼ˆ7ç¨®é¡ã®è¡Œå‹•ï¼‰</li>
        <li><strong>è¨ˆç®—ã—ãŸç‰¹å¾´</strong>: Xãƒ»Yãƒ»Zè»¸ãã‚Œãã‚Œã®æœ€å¤§å€¤ã€æœ€å°å€¤ã€å¹³å‡å€¤ã€åˆ†æ•£ï¼ˆåˆè¨ˆ12å€‹ï¼‰</li>
      </ul>

      <!-- 3. ãƒ†ã‚¹ãƒˆã®ç²¾åº¦ -->
      <h3 style="color: #555; margin-top: 25px;">3. ãƒ†ã‚¹ãƒˆã®ç²¾åº¦</h3>

      <div style="background-color: #f0f8ff; padding: 20px; border-left: 4px solid #4a90e2; margin: 20px 0;">
        <p style="font-size: 1.1em; margin: 0;">
          <strong>æ­£è§£ç‡: <span style="color: #4a90e2; font-size: 1.4em;">83.48%</span></strong>
        </p>
        <p style="margin: 10px 0 0 0; font-size: 0.9em; color: #666;">
          ï¼ˆãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã§ã¯86.96%ï¼‰
        </p>
      </div>

      <p style="line-height: 1.7;">
        <strong>èªè­˜ã§ãã‚‹7ç¨®é¡ã®è¡Œå‹•:</strong>
      </p>
      <ul style="line-height: 1.8;">
        <li><strong>é™æ­¢</strong>: å®Œç’§ã«èªè­˜ã§ããŸ</li>
        <li><strong>æ­©ãï¼ˆãƒã‚±ãƒƒãƒˆï¼‰</strong>: å®Œç’§ã«èªè­˜ã§ããŸ</li>
        <li><strong>æ­©ãï¼ˆæ‰‹æŒã¡ï¼‰</strong>: å®Œç’§ã«èªè­˜ã§ããŸ</li>
        <li><strong>éšæ®µä¸‹ã‚Š</strong>: å®Œç’§ã«èªè­˜ã§ããŸ</li>
        <li><strong>éšæ®µç™»ã‚Š</strong>: ã»ã¼å®Œç’§</li>
        <li><strong>æ­©ãï¼ˆéŸ³æ¥½ï¼‰</strong>: ã¾ã‚ã¾ã‚èªè­˜ã§ããŸ</li>
        <li><strong>èµ°ã‚Š</strong>: ã¾ã‚ã¾ã‚èªè­˜ã§ããŸï¼ˆãŸã¾ã«ä»–ã®è¡Œå‹•ã¨é–“é•ãˆã‚‹ï¼‰</li>
      </ul>

      <!-- 4. ã‚ã‹ã£ãŸã“ã¨ -->
      <h3 style="color: #555; margin-top: 25px;">4. ã‚ã‹ã£ãŸã“ã¨</h3>
      <p style="line-height: 1.7;">
        å·¦å³æ–¹å‘ï¼ˆYè»¸ï¼‰ã®å‹•ããŒä¸€ç•ªé‡è¦ã ã¨ã„ã†ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚ãƒã‚±ãƒƒãƒˆã«å…¥ã‚ŒãŸçŠ¶æ…‹ã ã¨ã€
        æ­©ãã¨ãã®ä½“ã®å·¦å³ã®æºã‚ŒãŒå¤§ããåŠ é€Ÿåº¦ã«ç¾ã‚Œã‚‹ã®ã§ã€ãã‚Œã§åˆ¤åˆ¥ã§ãã‚‹ã¿ãŸã„ã§ã™ã€‚
      </p>
      <p style="line-height: 1.7;">
        åˆ¤æ–­ã®æµã‚Œã¯ã“ã‚“ãªæ„Ÿã˜:
      </p>
      <pre style="background-color: #f5f5f5; padding: 15px; border-radius: 5px; overflow-x: auto; font-size: 0.9em;">
if (å·¦å³ã®å‹•ããŒå°ã•ã„) {
    â†’ é™æ­¢
} else if (å·¦å³ã®å‹•ããŒä¸­ãã‚‰ã„) {
    â†’ èµ°ã‚‹ã‹éšæ®µç™»ã‚Š
} else {
    â†’ æ­©ã
}</pre>

      <!-- 5. æ„Ÿæƒ³ -->
      <h3 style="color: #555; margin-top: 25px;">5. æ„Ÿæƒ³</h3>
      <p style="line-height: 1.7;">
        æ€ã£ãŸã‚ˆã‚Šé«˜ã„ç²¾åº¦ã§èªè­˜ã§ããŸã®ã§é©šãã¾ã—ãŸã€‚ç‰¹ã«é™æ­¢çŠ¶æ…‹ã¯100%æ­£ç¢ºã«åˆ¤åˆ¥ã§ãã¦ã€
        æ©Ÿæ¢°å­¦ç¿’ã®å®Ÿç”¨æ€§ã‚’å®Ÿæ„Ÿã§ãã¾ã—ãŸã€‚ãŸã ã€æ­©ãã¨èµ°ã‚‹ã‚’åŒºåˆ¥ã™ã‚‹ã®ã¯é›£ã—ãã¦ã€
        ã‚‚ã£ã¨ãƒ‡ãƒ¼ã‚¿ã‚’é›†ã‚ãŸã‚Šã€åˆ¥ã®ç‰¹å¾´ã‚’ä½¿ã£ãŸã‚Šã™ã‚Œã°æ”¹å–„ã§ããã†ã ã¨æ€ã„ã¾ã—ãŸã€‚
      </p>

      <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
      <div style="margin-top: 30px; padding-top: 15px; border-top: 1px solid #ddd; text-align: center; color: #999; font-size: 0.9em;">
        <p>æ„Ÿæƒ…ã¨è¡Œå‹•ã®ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚° ç¬¬3å›èª²é¡Œ</p>
      </div>

    </div>

  </body>


<!--  ===========================================  -->
<script type="text/javascript">

alert("Welcome to Activity Recognition with Feature Save!\n\nç‰¹å¾´é‡ã‚’è‡ªå‹•ä¿å­˜ã—ã¦ã‚³ãƒ”ãƒšã§ãã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã™ã€‚");

//CONFIG: Length of each time window
const NUM_DATA_PER_FRAME = 200;

//Arrays for saving the raw sensor data
var xdata = [];
var ydata = [];
var zdata = [];
var num_data = 0;

//Features
var xmin = 0.0;
var xmax = 0.0;
var xave = 0.0;
var xvariance = 0.0;
var ymin = 0.0;
var ymax = 0.0;
var yave = 0.0;
var yvariance = 0.0;
var zmin = 0.0;
var zmax = 0.0;
var zave = 0.0;
var zvariance = 0.0;

//NEW: Feature history storage
var featureHistory = [];
var frameCount = 0;
var hasHeader = false;

//////////////////////////////////////////////////////
//Function to get sensor access permission from the browser
//////////////////////////////////////////////////////
function requestMotionPermission(){
  if ( DeviceMotionEvent &&
       typeof DeviceMotionEvent.requestPermission === 'function' ){
      // iOS 13+ ã® Safari
      // è¨±å¯ã‚’å–å¾—
      DeviceMotionEvent.requestPermission().then(permissionState => {
	  if (permissionState === 'granted') {
              // è¨±å¯ã‚’å¾—ã‚‰ã‚ŒãŸå ´åˆã€devicemotionã‚’ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã«è¿½åŠ 
	      window.addEventListener("devicemotion", handleAcceleration, false);
	  } else {
              // è¨±å¯ã‚’å¾—ã‚‰ã‚Œãªã‹ã£ãŸå ´åˆã®å‡¦ç†
	      console.log("Permission not granted!");
	      alert("Permission not granted!");
	  }
      }).catch(console.error) // httpsé€šä¿¡ã§ãªã„å ´åˆãªã©ã§è¨±å¯ã‚’å–å¾—ã§ããªã‹ã£ãŸå ´åˆ

  } else {
      //For other devices
      console.log("detected other device. so adding listener...");
      window.addEventListener("devicemotion", handleAcceleration, false);
  }

}

function stopDeviceMotion(){
    window.removeEventListener("devicemotion", handleAcceleration, false);
    alert("ã‚»ãƒ³ã‚µãƒ¼åœæ­¢ã—ã¾ã—ãŸã€‚\nåé›†ãƒ•ãƒ¬ãƒ¼ãƒ æ•°: " + frameCount);
}


////////////////////////////////////////////////////////////////////
//Function(1): èª­ã¿è¾¼ã¾ã‚Œã¦ããŸæœ€æ–°ã®åŠ é€Ÿåº¦ãƒ‡ãƒ¼ã‚¿(X,Y,Z)ã‚’å‡¦ç†ã™ã‚‹é–¢æ•°
//  - ã“ã®é–¢æ•°ã¯(æ©Ÿç¨®ã«ã‚ˆã‚Šã¾ã™ãŒ) ç§’é€Ÿ10ã€œ100å›ã¨ã„ã†ã‚ˆã†ãªé«˜é »åº¦ã§å‘¼ã°ã‚Œã¾ã™
////////////////////////////////////////////////////////////////////
function handleAcceleration(ev){

    //alert("" + event.acceleration.x + " " + event.acceleration.y + " " + event.acceleration.z);
    $('#accel-x').text( ev.acceleration.x );
    xdata.push(ev.acceleration.x);
    $('#accel-y').text( ev.acceleration.y );
    ydata.push(ev.acceleration.y);
    $('#accel-z').text( ev.acceleration.z );
    zdata.push(ev.acceleration.z);
    $('#raw-data').append(ev.acceleration.x + ", " + ev.acceleration.y + ", " + ev.acceleration.z + "\n");

    num_data++;
    //If we have enough raw sensor data...
    if( num_data == NUM_DATA_PER_FRAME ){

	//execute feature calculations.
	featureExtraction();

	//Let's classify the activity!
	var current_activity = classify();
	var japanese_label = translateLabel(current_activity);
	$('#current_result').text( japanese_label );

	//NEW: Save features to history
	saveFeaturesToHistory();

	//clear the raw sensor data
	xdata=[];
	ydata=[];
	zdata=[];
	//Clear the textarea
	$('#raw-data').empty();
	//Counter back to 0
	num_data=0;
    }

}

////////////////////////////////////////////////////////////////////
//Function(2):ã‚»ãƒ³ã‚µãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ "feature"(ç‰¹å¾´é‡)ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°
//  - ã“ã®é–¢æ•°ã¯ NUM_DATA_PER_FRAME å¤‰æ•°ã§è¨­å®šã•ã‚ŒãŸæ•°ã ã‘ã‚»ãƒ³ã‚µãƒ‡ãƒ¼ã‚¿ãŒ
//    ã€Œè¨­å®šã•ã‚ŒãŸã‚¿ã‚¤ãƒ ãƒ•ãƒ¬ãƒ¼ãƒ ã€ã«ãŸã¾ã‚‹åº¦ã«å‘¼ã°ã‚Œã¾ã™ã€‚
//  - ä¾‹: ã‚»ãƒ³ã‚µãƒ‡ãƒ¼ã‚¿ãŒ 50Hz (=50 data / seconds)
//        NUM_DATA_PER_FRAME ãŒ 200 ã®å ´åˆ
//        â†’ ç´„4ç§’ã«1åº¦ã®é »åº¦ã§å‘¼ã°ã‚Œã¾ã™
////////////////////////////////////////////////////////////////////
//helper func. to calculate average
const arrAvg = arr => arr.reduce((a,b) => a + b, 0) / arr.length
//helper func. to calculate variance
const arrVariance = (arr, avg) => arr.reduce((sum, val) => sum + Math.pow(val - avg, 2), 0) / arr.length

function featureExtraction(){
    xmin = Math.min.apply(Math, xdata); $('#xmin').text(xmin);
    xmax = Math.max.apply(Math, xdata); $('#xmax').text(xmax);
    xave = arrAvg(xdata); $('#xave').text(xave);
    xvariance = arrVariance(xdata, xave); $('#xvariance').text(xvariance);

    ymin = Math.min.apply(Math, ydata); $('#ymin').text(ymin);
    ymax = Math.max.apply(Math, ydata); $('#ymax').text(ymax);
    yave = arrAvg(ydata); $('#yave').text(yave);
    yvariance = arrVariance(ydata, yave); $('#yvariance').text(yvariance);

    zmax = Math.max.apply(Math, zdata); $('#zmax').text(zmax);
    zmin = Math.min.apply(Math, zdata); $('#zmin').text(zmin);
    zave = arrAvg(zdata); $('#zave').text(zave);
    zvariance = arrVariance(zdata, zave); $('#zvariance').text(zvariance);
}

////////////////////////////////////////////////////////////////////
//Function(3): æœ€æ–°ãƒ•ãƒ¬ãƒ¼ãƒ ã«ãŠã‘ã‚‹ç‰¹å¾´é‡(feature)ã‹ã‚‰ã€ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ã®
//è¡Œå‹•ã‚’åˆ†é¡ (classify) ã™ã‚‹é–¢æ•°
//  - scikit-learnã§è¨“ç·´ã—ãŸæ±ºå®šæœ¨ãƒ¢ãƒ‡ãƒ«ã‹ã‚‰è‡ªå‹•ç”Ÿæˆ
//  - 7ç¨®é¡ã®è¡Œå‹•ã‚’èªè­˜
//  - äº¤å·®æ¤œè¨¼æ­£è§£ç‡: 83.48%ã€ãƒ†ã‚¹ãƒˆã‚»ãƒƒãƒˆæ­£è§£ç‡: 86.96%
//  - è¨“ç·´æ—¥: 2025-11-07
////////////////////////////////////////////////////////////////////
function classify() {
    if (yvariance <= 14.5938) {
        if (yvariance <= 0.6964) {
            if (zave <= 0.0527) {
                return 'still';
            } else {
                return 'stairs_down';
            }
        } else {
            if (xvariance <= 1.6177) {
                if (zvariance <= 3.7716) {
                    if (zmin <= -2.5994) {
                        return 'walking_hand';
                    } else {
                        return 'stairs_up';
                    }
                } else {
                    if (zmax <= 3.3985) {
                        return 'walking_hand';
                    } else {
                        return 'walking_music';
                    }
                }
            } else {
                if (ymin <= -4.9467) {
                    if (xvariance <= 11.4101) {
                        return 'running';
                    } else {
                        return 'running';
                    }
                } else {
                    if (xave <= 0.0569) {
                        if (xave <= -0.0151) {
                            return 'stairs_down';
                        } else {
                            return 'running';
                        }
                    } else {
                        return 'stairs_up';
                    }
                }
            }
        }
    } else {
        if (zave <= -0.1939) {
            return 'running';
        } else {
            return 'walking_pocket';
        }
    }
}

////////////////////////////////////////////////////////////////////
// è‹±èªãƒ©ãƒ™ãƒ«ã‚’æ—¥æœ¬èªã«å¤‰æ›ã™ã‚‹é–¢æ•°
////////////////////////////////////////////////////////////////////
function translateLabel(englishLabel) {
    const labelMap = {
        'running': 'èµ°ã‚Š',
        'stairs_down': 'éšæ®µä¸‹ã‚Š',
        'stairs_up': 'éšæ®µç™»ã‚Š',
        'still': 'é™æ­¢',
        'walking_hand': 'æ­©ãï¼ˆæ‰‹æŒã¡ï¼‰',
        'walking_music': 'æ­©ãï¼ˆéŸ³æ¥½ï¼‰',
        'walking_pocket': 'æ­©ãï¼ˆãƒã‚±ãƒƒãƒˆï¼‰'
    };
    return labelMap[englishLabel] || englishLabel;
}

////////////////////////////////////////////////////////////////////
//NEW Function(4): è¨ˆç®—ã—ãŸç‰¹å¾´é‡ã‚’å±¥æ­´ã«ä¿å­˜ã™ã‚‹é–¢æ•°
////////////////////////////////////////////////////////////////////
function saveFeaturesToHistory(){
    // Get current activity label from input
    var label = $('#activity-label').val() || 'unknown';

    // Create CSV header (only once)
    if(!hasHeader){
        var header = "label, xmax, xmin, xave, xvariance, ymax, ymin, yave, yvariance, zmax, zmin, zave, zvariance\n";
        $('#feature-history').val(header);
        hasHeader = true;
    }

    // Create CSV line
    var csvLine = label + ", " +
                  xmax.toFixed(4) + ", " +
                  xmin.toFixed(4) + ", " +
                  xave.toFixed(4) + ", " +
                  xvariance.toFixed(4) + ", " +
                  ymax.toFixed(4) + ", " +
                  ymin.toFixed(4) + ", " +
                  yave.toFixed(4) + ", " +
                  yvariance.toFixed(4) + ", " +
                  zmax.toFixed(4) + ", " +
                  zmin.toFixed(4) + ", " +
                  zave.toFixed(4) + ", " +
                  zvariance.toFixed(4) + "\n";

    // Add to textarea
    $('#feature-history').append(csvLine);

    // Update frame count
    frameCount++;
    $('#frame-count').text(frameCount);

    // Auto scroll to bottom
    var textarea = document.getElementById('feature-history');
    textarea.scrollTop = textarea.scrollHeight;
}

////////////////////////////////////////////////////////////////////
//NEW Function(5): ç‰¹å¾´é‡å±¥æ­´ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
////////////////////////////////////////////////////////////////////
function copyFeatures(){
    var featureText = $('#feature-history').val();

    if(!featureText || featureText.trim() === ''){
        alert('ã‚³ãƒ”ãƒ¼ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
    }

    // Copy to clipboard
    navigator.clipboard.writeText(featureText).then(function() {
        alert('ç‰¹å¾´é‡ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\n\nãƒ•ãƒ¬ãƒ¼ãƒ æ•°: ' + frameCount);
    }, function(err) {
        // Fallback for older browsers
        var textarea = document.getElementById('feature-history');
        textarea.select();
        document.execCommand('copy');
        alert('ç‰¹å¾´é‡ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\n\nãƒ•ãƒ¬ãƒ¼ãƒ æ•°: ' + frameCount);
    });
}

////////////////////////////////////////////////////////////////////
//NEW Function(6): ç‰¹å¾´é‡å±¥æ­´ã‚’ã‚¯ãƒªã‚¢
////////////////////////////////////////////////////////////////////
function clearFeatures(){
    if(frameCount === 0){
        alert('ã‚¯ãƒªã‚¢ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
    }

    if(confirm('ç‰¹å¾´é‡å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ\nç¾åœ¨ã®ãƒ•ãƒ¬ãƒ¼ãƒ æ•°: ' + frameCount)){
        $('#feature-history').val('');
        frameCount = 0;
        hasHeader = false;
        $('#frame-count').text(frameCount);
        alert('å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
    }
}

</script>
<!--  ===========================================  -->


</html>
